<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Property Descriptors Tests</title>
<link rel="stylesheet" href="../qunit/qunit.css" type="text/css" media="screen" />
<script type="text/javascript" src="../qunit/qunit.js"></script>
<script>
test("Named Data Property Semantics", function() {
  ok(function () {
    var obj = Object.defineProperty({}, 'foo', { value: '' }),
        desc = Object.getOwnPropertyDescriptor(obj, 'foo');
    // References: 8.6.1 Table 7 and [[DefineOwnProperty]] 8.12.9
    return desc.enumerable === false && desc.configurable === false &&
           desc.writable === false;
  }(), "[[Enumerable]], [[Configurable]] and [[Writable]] property attributes default to `false` if absent" );

  ok(function () {
    var obj = Object.defineProperty({}, 'foo', {
      value: 'foo',
      writable: false // specifying false due the IE9pre3 bug
    });
    
    obj.foo = 'bar';
    // References: 8.6.1 Table 5, [[CanPut]] 8.12.4 and [[Put]] 8.12.5
    return obj.foo === 'foo';
  }(), "When [[Writable]] is `false` the [[Value]] of a named data property cannot be changed");
  
  ok(function () {
    var obj = Object.defineProperty({}, 'foo', {
      value: 'foo',
      configurable: false // specifying false due the IE9pre3 bug
    });
    
    try {
      Object.defineProperty(obj, 'foo', { get: function () { return 'bar'; } });
    } catch (e) {
      return e instanceof TypeError;
    }
    // References: 8.6.1 Table 5 and [[DefineOwnProperty]] 8.12.9-9.a
  }(), "When [[Configurable]] is set to `false` an attempt to convert the property to an Accessor Property fails" );

  ok(function () {
    var obj = Object.defineProperty({}, 'foo', {
      value: 'foo',
      configurable: false // specifying false due the IE9pre3 bug
    });
    
    try {
      Object.defineProperty(obj, 'foo', { configurable: true });
    } catch (e) {
      return e instanceof TypeError;
    }
    // References: 8.6.1, Table 5 and [[DefineOwnProperty]] 8.12.9-10.a
  }(), "When [[Configurable]] is set to `false` an attempt to change a property attribute other than [[Value]] fails" );

  ok(function () {
    var obj = Object.defineProperty({}, 'foo', {
      value: 'foo',
      configurable: false, // specifying false due the IE9pre3 bug
      writable: true // of course writable needs to be true
    });

    Object.defineProperty(obj, 'foo', { value: 'bar' });
    return obj.foo === 'bar';
    // References: 8.6.1, Table 5 and [[DefineOwnProperty]] 8.12.9-10.a
  }(), "When [[Configurable]] is set to `false`, the [[Value]] attribute can be changed" );
});
    
test("Named Accessor Property Semantics", function() {
  ok(function () {
    var obj = Object.defineProperty({}, 'foo', {
      get: function () { return ''; }
    }), desc = Object.getOwnPropertyDescriptor(obj, 'foo');
    
    return desc.enumerable === false && desc.configurable === false;
    // References: 8.6.1 Table 7 and [[DefineOwnProperty]] 8.12.9-4.b.i
  }(), "[[Enumerable]], and [[Configurable]] property attributes default to `false` if absent");

  ok(function () {
    var obj = Object.defineProperties({}, {
      'noSet': { get: function () {} },
      'noGet': { set: function () {} }
    }), noSetDesc = Object.getOwnPropertyDescriptor(obj, 'noSet'),
        noGetDesc = Object.getOwnPropertyDescriptor(obj, 'noGet');

    return noSetDesc.set === undefined  && noGetDesc.get === undefined;
    // References: 8.6.1 Table 7 and [[DefineOwnProperty]] 8.12.9-4.b.i
  }(), "[[Get]] and [[Set]] property attributes default to `undefined` if absent" );

  ok(function () {
    var obj = Object.defineProperties({}, {
      'foo': { get: undefined, set: undefined }
      // This is a valid accessor property, the internal IsAccessorDescriptor (8.10.1)
      // method returns `false` only if [[Get]] and [[Set]] are absent, and that's 
      // not the case, they are undefined, which is a valid value (8.6.1, Table 6)
    }), desc = Object.getOwnPropertyDescriptor(obj, 'foo');

    try { // IE9pre3 throws on both, [[Put]] and [[Get]](P)
      obj.foo = 'bar'; // The internal [[CanPut]] method (8.12.4) should return false if the setter is undefined
      return obj.hasOwnProperty('foo') && obj.foo === undefined // Should be undefined because [[Get]](P) (8.12.3) returns undefined if the getter is undefined 
             && desc.hasOwnProperty('get') && desc.get === undefined 
             && desc.hasOwnProperty('set') && desc.set === undefined;
    } catch (e) {
      return false;
    }
  }(), "`undefined` is a valid value for the [[Get]] and [[Set]] property attributes, a non-setteable, own property that returns `undefined` as its value should be defined");

  ok(function () {
    try {
      Object.defineProperty({}, "test", { get: false });
    } catch (e) {
      return e instanceof TypeError;
    }
    // References: ToPropertyDescriptor 8.10.5-7.b
  }(), "TypeError expected if [[Get]] not callable or undefined");

  ok(function () {
    try {
      Object.defineProperty({}, "foo", { set: false });
    } catch (e) {
      return e instanceof TypeError;
    }
    // References: ToPropertyDescriptor 8.10.5-8.b
  }(), "TypeError expected if [[Set]] not callable or undefined");
});

test("General", function () {
  ok(function () {
    var obj = Object.defineProperty({}, 'foo', {});
    return obj.hasOwnProperty('foo') && obj.foo === undefined;
    // References: 8.10, [[DefineOwnProperty]] 8.12.9 
  }(), "A generic property descriptor (one that's neither data descriptor nor accessor descriptor) produces a data property with the default `undefined` value");

  ok(function () {
    var obj = Object.defineProperties({}, {
      'foo': {
        value: 'foo',
        configurable: false // specifying false due the IE9pre3 bug
      },
      'bar': {
        get: function () {},
        configurable: false
      }
    });

    return !(delete obj.foo) && obj.hasOwnProperty('foo') &&
           !(delete obj.bar) && obj.hasOwnProperty('bar');
    // References: 8.6.1, Table 5 and 6, [[Delete]] 8.12.7
  }(), "When [[Configurable]] is set to `false` an attempt to delete a property fails" );

  ok(function () {
    var result;
    try {
      Object.defineProperty({}, "foo", { get: function () { return "foo"; }, writable: true});
      return false;
    } catch (e) {
      result = e instanceof TypeError;
    }

    try {
      Object.defineProperty({}, "foo", { set: function () {}, writable: true});
      return false;
    } catch (e) {
      result = result && e instanceof TypeError;
    }

    try {
      Object.defineProperty({}, "foo", { get: function () { return "foo"; }, value: true });
      return false;
    } catch (e) {
      result = result && e instanceof TypeError;
    }

    try {
      Object.defineProperty({}, "foo", { get: function () {}, value: true });
      return false;
    } catch (e) {
      result = result && e instanceof TypeError;
    }

    return result;
    // References: ToPropertyDescriptor 8.10.5-9.a
  }(), "[[Get]] or [[Set]] cannot be combined with [[Value]] or [[Writable]], a TypeError is expected");
});
</script>
  
</head>
<body>
 <h1 id="qunit-header">Property Descriptors Tests</h1>
 <h2 id="qunit-banner"></h2>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
</body>
</html>
